---
import { useTranslations } from '../utils/i18n';
const { lang, t: propT } = Astro.props;
const t = propT || useTranslations(lang as any);
---
<header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-border-dark px-6 py-4 lg:px-20 bg-background-dark/95 backdrop-blur sticky top-0 z-50">
  <div class="flex items-center gap-4 text-white">
    <div class="size-6 text-primary animate-pulse">
      <span class="material-symbols-outlined">terminal</span>
    </div>
    <h2 class="text-white text-lg font-bold leading-tight tracking-wider">ADRIAN_VERGEL<span class="text-primary animate-blink">_</span></h2>
  </div>
  <div class="hidden md:flex flex-1 justify-end gap-8">
    <nav class="flex items-center gap-8" aria-label="Navegación principal">
      <a class="nav-link text-slate-400 hover:text-primary transition-colors text-sm font-medium tracking-widest" href={`/${lang}`} aria-label={t('nav.home')}>{t('nav.home')}</a>
      <a class="nav-link text-slate-400 hover:text-primary transition-colors text-sm font-medium tracking-widest" href={Astro.url.pathname === `/${lang}/` || Astro.url.pathname === `/${lang}` ? "#projects" : `/${lang}/#projects`} data-section="projects" aria-label={t('nav.projects')}>{t('nav.projects')}</a>
      <a class="nav-link text-slate-400 hover:text-primary transition-colors text-sm font-medium tracking-widest" href={Astro.url.pathname === `/${lang}/` || Astro.url.pathname === `/${lang}` ? "#experience" : `/${lang}/#experience`} data-section="experience" aria-label={t('nav.experience')}>{t('nav.experience')}</a>
      <a class="nav-link text-slate-400 hover:text-primary transition-colors text-sm font-medium tracking-widest" href={Astro.url.pathname === `/${lang}/` || Astro.url.pathname === `/${lang}` ? "#contact" : `/${lang}/#contact`} data-section="contact" aria-label={t('nav.contact')}>{t('nav.contact')}</a>
    </nav>
    
    <!-- Language Switcher - Improved -->
    <div class="flex items-center gap-2 px-4 border-l border-border-dark">
      <a 
        href={lang === 'es' ? '/en' : '/es'} 
        class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-white/5 border border-white/10 hover:bg-primary/10 hover:border-primary transition-all duration-300 group"
      >
        <span class="material-symbols-outlined text-sm text-slate-500 group-hover:text-primary transition-colors">language</span>
        <span class="text-xs font-mono text-slate-400 group-hover:text-primary transition-colors font-bold">
          {lang === 'es' ? 'EN' : 'ES'}
        </span>
      </a>
    </div>

    <a 
      href="/CV_Adrian_Vergel.pdf"
      download="CV_Adrian_Vergel.pdf"
      class="flex items-center justify-center overflow-hidden rounded h-9 px-5 bg-primary/10 hover:bg-primary/20 border border-primary text-primary hover:text-white transition-all duration-300 text-xs font-bold tracking-widest uppercase"
      aria-label={t('nav.cv')}
    >
      <span class="mr-2 material-symbols-outlined text-sm" aria-hidden="true">download</span>
      {t('nav.cv')}
    </a>
  </div>
  <!-- Mobile Menu Button -->
  <button id="mobile-menu-btn" class="md:hidden text-white relative z-50 p-2" aria-label="Toggle navigation menu">
    <span class="material-symbols-outlined text-3xl">menu</span>
  </button>

</header>

<!-- Mobile Menu Overlay -->
<div id="mobile-menu" class="fixed inset-0 bg-[#0a0a0a]/98 backdrop-blur-2xl z-60 transform translate-x-full transition-transform duration-500 ease-out md:hidden flex flex-col justify-center items-center gap-10">
  <!-- Decorative background elements -->
  <div class="absolute inset-0 overflow-hidden pointer-events-none">
    <div class="absolute top-1/4 left-1/4 w-64 h-64 bg-primary/5 rounded-full blur-3xl"></div>
    <div class="absolute bottom-1/4 right-1/4 w-80 h-80 bg-blue-500/5 rounded-full blur-3xl"></div>
  </div>

  <nav class="flex flex-col items-center gap-8 relative z-10 text-center">
    <a class="mobile-nav-link text-2xl font-bold tracking-widest text-slate-300 hover:text-primary transition-all duration-300 hover:scale-110" href={`/${lang}`} aria-label={t('nav.home')}>{t('nav.home')}</a>
    <a class="mobile-nav-link text-2xl font-bold tracking-widest text-slate-300 hover:text-primary transition-all duration-300 hover:scale-110" href={Astro.url.pathname === `/${lang}/` || Astro.url.pathname === `/${lang}` ? "#projects" : `/${lang}/#projects`} aria-label={t('nav.projects')}>{t('nav.projects')}</a>
    <a class="mobile-nav-link text-2xl font-bold tracking-widest text-slate-300 hover:text-primary transition-all duration-300 hover:scale-110" href={Astro.url.pathname === `/${lang}/` || Astro.url.pathname === `/${lang}` ? "#experience" : `/${lang}/#experience`} aria-label={t('nav.experience')}>{t('nav.experience')}</a>
    <a class="mobile-nav-link text-2xl font-bold tracking-widest text-slate-300 hover:text-primary transition-all duration-300 hover:scale-110" href={Astro.url.pathname === `/${lang}/` || Astro.url.pathname === `/${lang}` ? "#contact" : `/${lang}/#contact`} aria-label={t('nav.contact')}>{t('nav.contact')}</a>
    
    <a 
      href="/CV_Adrian_Vergel.pdf"
      download="CV_Adrian_Vergel.pdf"
      class="mt-4 flex items-center justify-center gap-2 px-6 py-3 rounded-full bg-primary/10 border border-primary/30 text-primary font-bold tracking-wider uppercase text-sm hover:bg-primary hover:text-black transition-all duration-300"
    >
      <span class="material-symbols-outlined text-lg">download</span>
      {t('nav.cv')}
    </a>
  </nav>

  <!-- Mobile Language Switcher -->
  <a 
    href={lang === 'es' ? '/en' : '/es'} 
    class="relative z-10 flex items-center gap-3 px-5 py-2.5 rounded-full bg-white/5 border border-white/10 text-slate-400 font-mono text-xs hover:text-primary hover:border-primary transition-all duration-300"
  >
    <span class="material-symbols-outlined text-lg">language</span>
    {lang === 'es' ? 'SWITCH TO ENGLISH' : 'CAMBIAR A ESPAÑOL'}
  </a>

  <!-- Close Button for Clarity -->
  <button id="close-menu-btn" class="absolute top-6 right-6 text-white/50 hover:text-white transition-colors" aria-label="Close menu">
    <span class="material-symbols-outlined text-4xl">close</span>
  </button>
</div>

<script>
  // Mobile Menu Logic
  const mobileMenuBtn = document.getElementById('mobile-menu-btn');
  const closeMenuBtn = document.getElementById('close-menu-btn');
  const mobileMenu = document.getElementById('mobile-menu');
  const mobileNavLinks = document.querySelectorAll('.mobile-nav-link');
  const menuIcon = mobileMenuBtn?.querySelector('.material-symbols-outlined');

  function openMenu() {
    mobileMenu?.classList.remove('translate-x-full');
    document.body.style.overflow = 'hidden'; // Prevent scrolling
    if (menuIcon) menuIcon.textContent = 'close';
  }

  function closeMenu() {
    mobileMenu?.classList.add('translate-x-full');
    document.body.style.overflow = ''; // Restore scrolling
    if (menuIcon) menuIcon.textContent = 'menu';
  }

  function toggleMobileMenu() {
    if (mobileMenu?.classList.contains('translate-x-full')) {
      openMenu();
    } else {
      closeMenu();
    }
  }

  mobileMenuBtn?.addEventListener('click', toggleMobileMenu);
  closeMenuBtn?.addEventListener('click', closeMenu);

  // Close menu when a link is clicked
  mobileNavLinks.forEach(link => {
    link.addEventListener('click', closeMenu);
  });

  // Dynamic active section detection
  const sections = document.querySelectorAll('section[id]');
  const navLinks = document.querySelectorAll('.nav-link');

  function setActiveLink() {
    let currentSection = '';
    
    sections.forEach(section => {
      const htmlSection = section as HTMLElement;
      const sectionTop = htmlSection.offsetTop;
      const sectionHeight = htmlSection.clientHeight;
      
      if (window.scrollY >= sectionTop - 100) {
        currentSection = section.getAttribute('id') || '';
      }
    });

    navLinks.forEach(link => {
      link.classList.remove('text-white', 'border-b-2', 'border-primary', 'pb-1', 'font-bold');
      link.classList.add('text-slate-400', 'font-medium');
      
      const href = link.getAttribute('href');
      // Check if href matches current section ID
      if (href?.includes(`#${currentSection}`) && currentSection !== '') {
         link.classList.remove('text-slate-400', 'font-medium');
         link.classList.add('text-white', 'border-b-2', 'border-primary', 'pb-1', 'font-bold');
      }
    });
  }

  // Set active link on scroll
  window.addEventListener('scroll', setActiveLink);
  
  // Set active link on page load
  setActiveLink();
</script>
